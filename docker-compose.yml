version: '3.8'

services:
  # Frontend (Optimized Nginx)
  frontend:
    image: nginx:alpine
    ports:
      - "3000:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d:ro # Load custom config
      - ./index.html:/usr/share/nginx/html/index.html:ro
      - ./styles.css:/usr/share/nginx/html/styles.css:ro
      - ./app.js:/usr/share/nginx/html/app.js:ro
      - ./examples.html:/usr/share/nginx/html/examples.html:ro
      - ./examples-data.js:/usr/share/nginx/html/examples-data.js:ro
      - ./tutorials.html:/usr/share/nginx/html/tutorials.html:ro
      - ./tutorials.js:/usr/share/nginx/html/tutorials.js:ro
      - ./editor.html:/usr/share/nginx/html/editor.html:ro
      - ./privacy.html:/usr/share/nginx/html/privacy.html:ro
      - ./terms.html:/usr/share/nginx/html/terms.html:ro
      - ./logo.png:/usr/share/nginx/html/logo.png:ro
      - ./favicon.ico:/usr/share/nginx/html/favicon.ico:ro
      - ./favicon-48x48.png:/usr/share/nginx/html/favicon-48x48.png:ro
      - ./favicon-96x96.png:/usr/share/nginx/html/favicon-96x96.png:ro
      - ./favicon-192x192.png:/usr/share/nginx/html/favicon-192x192.png:ro
      - ./favicon-512x512.png:/usr/share/nginx/html/favicon-512x512.png:ro
      - ./python-online-compiler.html:/usr/share/nginx/html/python-online-compiler.html:ro
      - ./java-online-compiler.html:/usr/share/nginx/html/java-online-compiler.html:ro
      - ./cpp-online-compiler.html:/usr/share/nginx/html/cpp-online-compiler.html:ro
    depends_on:
      - backend
    networks:
      - coderunner-network

  # Backend API Server
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - PORT=3001
      - PISTON_URL=http://piston:2000/api/v2
    depends_on:
      - piston
    networks:
      - coderunner-network
    restart: unless-stopped

  # Piston Code Execution Engine
  piston:
    image: ghcr.io/engineer-man/piston
    ports:
      - "2000:2000"
    privileged: true
    volumes:
      - piston_packages:/piston/packages # PERSISTENCE: Downloads saved here!
    networks:
      - coderunner-network
    restart: unless-stopped
    # Improved entrypoint: checks if packages exist before installing to save time
    entrypoint: >
      /bin/sh -c "
        if [ ! -d '/piston/packages/python' ]; then
          echo 'First run detected! Installing language runtimes (this happens only once)...' &&
          piston ppman install python java gcc g++ csharp.net node typescript go rust ruby php dart swift scala rlang sqlite3
        else
          echo 'Runtimes already installed! Starting fast...'
        fi &&
        /piston_api
      "

networks:
  coderunner-network:
    driver: bridge

volumes:
  piston_packages: # Named volume for persistence
